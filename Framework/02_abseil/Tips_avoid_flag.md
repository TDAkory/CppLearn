# Flags

## Avoid Flags, Especially in Library Code

文档核心观点为：**不建议在生产代码（尤其库代码）中使用标志位（Flags）**，仅在极少数必要场景下可谨慎使用，同时提供了更优的替代方案。

1. **标志位的本质与核心问题**
   - 标志位本质是“更糟的全局变量”：其值无法通过代码静态预测，可能在启动后通过任意方式动态修改，且无变更通知、变更日志记录不完整，服务器运行中甚至无法保证标志位值的稳定性。
   - 具体问题：
     1. 不确定性高：库代码中无法判断某功能是否因标志位未被使用而失效，难以清理冗余功能；
     2. 阻碍死代码清理：若遗留代码中存在大量生产环境引用的标志位，删除旧代码会导致二进制文件启动失败，给发布工程师带来极大麻烦；
     3. 多数标志位无实际意义：谷歌2012年初的分析显示，绝大多数C++标志位在数据留存周期内从未发生过值变更，没必要通过标志位控制。

2. **标志位的合理适用场景**
   - 调试场景：支持标志位的回溯功能对调试至关重要；
   - 功能标志位：处理得当且后续及时清理的功能标志位（如灰度发布、特性切换）；
   - 应急控制参数开关：供SRE（站点可靠性工程师）紧急调整的系统参数（安全兜底）；
   - 二进制输入：仅在`main()`函数中用于传递名值对输入，比位置参数更易维护。

3. **替代方案与实践建议**
   - 显式传递配置：优先通过显式参数传递配置，更易推理逻辑、降低维护成本；
   - 编译时常量：将数值型标志位改为编译时常量，避免运行时不确定性；
   - 严格审查：代码审查中对新增标志位提出质疑，要求每个标志位的引入都必须提供正当理由，避免滥用。

## Configuration knobs considered harmful

本文核心观点为：**配置参数开关(Configuration knob)（Flags、选项等可覆盖默认行为的机制）短期有实用价值，但长期会产生技术债务、阻碍优化迭代、引发配置乱象，应谨慎使用并制定明确的清理策略**。

1. **配置参数开关的短期价值与理想生命周期**
   - 短期用途：适用于特性迁移（解耦代码发布与特性启用）、应对临时特殊需求、新特性灰度发布（提供回滚通道）、支持早期用户试用。
   - 理想案例：TCMalloc的大页感知分配器优化，通过flag支持用户早期试用，同时为少数出现资源需求变化的应用提供退避选项，避免整体回滚影响多数用户的性能收益。
   - 合理性判断（基于用户占比）：
     - 少数用户使用：阻碍后续演进，不建议保留；
     - 中等规模用户：可接受但难最优配置（仅特性作者掌握足够上下文）；
     - 近100%用户使用（作为新默认值的退避选项）：合理，但必须在发布完成后清理，避免沦为技术债务。

2. **配置参数开关的长期核心问题**
   - 「意图传达失效」：参数单位不透明、副作用不直观，用户易误配置；
     - 案例：Abseil的SwissMap未实现`max_load_factor`（仅为API兼容设为无操作），因用户常误解其作用——想通过`max_load_factor(0.25)`“以内存换速度”，却导致CPU性能下降+内存占用增加；且不同哈希表实现（开放寻址vs链式）中该参数含义不一致，迁移后易出问题。
   - 「配置过时失效」：库的默认值会随优化迭代更新，但硬编码的配置会覆盖默认值；用户易忽视底层基础设施改进，导致旧配置比当前默认值性能更差。
   - 「降低长期迭代速度」：
     - 增加状态空间，加大后续修改的推理、测试难度，阻碍新特性落地；
     - 少数修改配置的用户可能被高层API“半支持”（高层API默认假设默认行为）；
     - 案例：TCMalloc移除冷门的`malloc hooks`和`sbrk`分配器后，简化了代码结构，实现了更多虚拟地址空间优化。

3. **扩展：API与库的类似挑战**
   - 新库（如Y）替代旧库（如X）时，需用户主动迁移才能发挥价值；若缺乏主动迁移，会因生态兼容、数据转换成本等问题，导致“多套方案共存却无法兑现性能收益”（如自定义`super_fast_string`难以替代`std::string`）。
   - 例外情况：确有必要时（如SwissMap需打破`std::unordered_map`的稳定性保证），新库需以“完全迁移”为目标，简化用户选择（如“直接使用SwissMap”），避免长期维护多套方案的成本。

4. **最佳实践建议**
   - 新增配置时，需预判长期演进路径，避免无意义的可配置性；
   - 特性flag需制定明确清理计划（发布完成后移除退避选项），不遗留技术债务；
   - 优先设计优质默认值或自调优机制（让参数随工作负载自动适配），减少用户手动配置需求；
   - 配置的有效使用依赖特性作者的上下文，用户难以最优选择，应尽量降低配置门槛。

## Ref

- [Tip of the Week #45: Avoid Flags, Especially in Library Code](https://abseil.io/tips/45)
- [Performance Tip of the Week #52: Configuration knobs considered harmful](https://abseil.io/fast/52)