# Tips of Optimization

## Performance Tip of the Week #7: Optimizing for application productivity

本文是Google发布的性能优化技巧系列第7篇，核心主题是**以“应用生产力”为核心进行优化**，而非依赖传统资源消耗或指令相关指标。

### 核心背景与核心指标

- Google服务器集群的核心目标是完成“有用工作”（如处理搜索查询、转码视频等），而非单纯降低资源消耗（如CPU占用、内存分配耗时）。
- 单纯的资源消耗指标（如CPU使用率上升）无法区分“工作负载增加”（如处理更多视频）和“效率下降”（如无用的协议转换），因此需要**应用生产力指标（APMs）** ——即每单位资源（CPU秒、内存字节秒、磁盘操作、硬件加速器时间）完成的实际工作总量（如处理的视频数量），以此衡量优化价值。

### 传统指标的局限性（需APMs补充的场景）

传统指标（如MIPS、IPC、组件相对耗时）无法准确反映以下关键优化的价值，甚至可能误导决策：

1. **核心基础设施变更优化**
   - TCMalloc的大页感知分配器（Temeraire）：虽增加了TCMalloc自身的相对耗时，但通过优化数据布局提升了整体应用性能，属于正向优化。
   - Protocol Buffer的Arenas分配：不仅加速了协议缓冲区代码（如消息析构），还优化了业务逻辑的数据局部性，使主流框架每CPU能多处理15-30%的工作。
2. **新指令集应用**
   - 新硬件指令（如`rep movsb`、AVX、FMA、BMI）虽可能降低MIPS（每秒百万指令数）或IPC（每周期指令数），但单指令能完成更多工作（如`rep movsb`替代复制循环），实际提升处理效率。例如，用`--march=haswell`编译启用新指令集时，虽MIPS下降，但查询耗时减少、QPS提升。
3. **编译器优化**
   - 内联等优化会减少动态执行的指令数，虽降低“指令总量”相关指标，但简化了代码并加速执行，提升生产力。
4. **内核优化**
   - 调整大页策略、线程调度等内核参数可能增加内核自身开销（如内存压缩工作量），但应用层面的收益远大于这些成本。

### 核心结论

- 应用生产力指标（APMs）是衡量优化价值的关键，能帮助团队识别传统指标无法覆盖的有效优化。
- 优化的核心目标是“提升单位资源的有用工作量”，而非单纯降低某一组件的耗时或提升指令相关指标，这一导向能更高效地优化Google服务器集群的整体效率。

## Ref

- [Performance Tip of the Week #7: Optimizing for application productivity](https://abseil.io/fast/7)
