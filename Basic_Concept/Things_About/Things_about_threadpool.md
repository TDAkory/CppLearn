# 手写线程池

## 模型

### 线程池的类型

| 类别                    | 核心特征                   | 优点                 | 缺点                | 典型场景           |
| --------------------- | ---------------------- | ------------------ | ----------------- | -------------- |
| **固定线程池** (Static)    | 启动即创建 N 条线程，永不伸缩       | 零延迟调度；无动态开销        | 无法应对突发流量；线程数需人工调优 | 高频交易、实时游戏帧逻辑   |
| **动态线程池** (Cached)    | 初始少量线程，任务积压时再创建，空闲超时回收 | 资源弹性好，CPU/内存按需分配   | 创建-销毁仍有成本；可能无限增长  | Web 服务器、移动端后台  |
| **调度线程池** (Scheduled) | 在动态基础上支持定时/周期性任务       | 一次封装解决延迟 & 周期执行    | 实现复杂；需要最小堆或时间轮    | 心跳、日志滚动、缓存失效   |
| **Fork-Join 池**       | 工作窃取 + 任务分裂合并          | 高并行度；自动负载均衡        | 仅适合可递归拆分任务；实现门槛高  | 并行排序、MapReduce |
| **IO 线程池**            | 专门处理阻塞 IO（读/写/网络）      | 把阻塞操作隔离，不占用 CPU 线程 | 额外线程开销；需双池协作      | 文件、DB、RPC 网关   |

### 任务队列形态

| 队列策略                             | 线程安全机制          | 性能              | 适用              |
| -------------------------------- | --------------- | --------------- | --------------- |
| 有锁 `std::queue + mutex`          | 互斥锁             | 实现简单，竞争激烈时性能下降  | 中小规模任务          |
| 无锁 `moodycamel::ConcurrentQueue` | CAS/原子指令        | 高并发低延迟，CPU 消耗略高 | 高频交易、日志系统       |
| 分层队列                             | 按优先级或任务类型分多个子队列 | 减少锁竞争，代码复杂      | 游戏引擎 Job System |
